#!/usr/bin/env node
//@ts-check

/* eslint-disable @typescript-eslint/no-var-requires */

const ExitCodes = {
    Ok: 0,
    OptionError: 1,
    NoEntryPoints: 2,
    CompileError: 3,
    OutputError: 4,
};

const td = require("..");
const { getOptionsHelp } = require("../dist/lib/utils/options/help");

const app = new td.Application();

app.options.addReader(new td.ArgumentsReader(0));
app.options.addReader(new td.TypeDocReader());
app.options.addReader(new td.TSConfigReader());
app.options.addReader(new td.ArgumentsReader(300));

app.bootstrap();

process.exit(run(app));

/** @param {td.Application} app */
function run(app) {
    if (app.options.getValue("version")) {
        console.log(app.toString());
        return ExitCodes.Ok;
    }

    if (app.options.getValue("help")) {
        console.log(getOptionsHelp(app.options));
    }

    if (app.logger.hasErrors()) {
        return ExitCodes.OptionError;
    }

    if (app.options.getValue("entryPoints").length === 0) {
        app.logger.error("No entry points provided");
        return ExitCodes.NoEntryPoints;
    }

    const project = app.convert();
    if (!project) {
        return ExitCodes.CompileError;
    }

    const out = app.options.getValue("out");
    if (out) {
        app.generateDocs(project, out);
    }
    const json = app.options.getValue("json");
    if (json) {
        app.generateJson(project, json);
    }

    if (!out && !json) {
        app.generateDocs(project, "./docs");
    }

    if (app.logger.hasErrors()) {
        return ExitCodes.OutputError;
    }
    return ExitCodes.Ok;
}
